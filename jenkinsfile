node{
    stage ("Repo Pull"){
        if (fileExists("/data/cookbooks/${env.JOB_NAME}")) {
            sh "cd /data/cookbooks/${env.JOB_NAME}; git pull"
        } else {
            sh "git clone https://TrekDevOps:WQrULM66cGyPyB@bitbucket.org/trekbikes/${env.JOB_NAME}.git /data/cookbooks/${env.JOB_NAME}"
        }
    }
    stage("lint testing"){
        sh "foodcritic /data/cookbooks/${env.JOB_NAME} --epic-fail any"
    }
    stage("syntax testing"){
        sh "rubocop /data/cookbooks/${env.JOB_NAME}"
    }
    stage("testing cookbook"){
        sh "cd /data/cookbooks/${env.JOB_NAME}; kitchen test"
    }
    stage("push to chef server"){
       sh """
        source /etc/profile
        cd /data/cookbooks/${env.JOB_NAME}
        if test ! -e .berkshelf ; then
          mkdir .berkshelf
        fi
        echo '{"ssl": {"verify": false}}' > .berkshelf/config.json
        echo -e "source :chef_server\nsource 'https://supermarket.chef.io'\n\nmetadata" > Berksfile
        berks install
        berks upload
       """
    }
}

// TO DO 
// Add Kitchen.yml replacement for cookbook when it is run. 
// Figure out a way to do restart with test-kitchen. 